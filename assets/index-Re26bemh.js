import{j as n}from"./chakra-Blar0cOi.js";import{r as d}from"./react-BGwHOppr.js";import{h as P,aW as k,u as S,m as he,S as j,aU as w,P as $}from"./index-DRl3UGBc.js";import{a as fe,c as v,b as xe,d as ge,S as ae}from"./share-BnnfsONq.js";import{i as ye}from"./param-selector-f9SMGuH6.js";function _e(e){const{num:t,inStrip:s,...r}=e;return n.jsxs("g",{textAnchor:"middle",fill:s?P.black:"var(--rmg-theme-fg)",...r,children:[n.jsx("rect",{height:40,width:40,rx:4,x:-20,fill:s?"#fff":"var(--rmg-theme-colour)"}),n.jsx("text",{className:"rmg-name__en",fontSize:20,dy:12,children:t}),n.jsx("text",{className:"rmg-name__zh",fontSize:12,dy:26,children:"屏蔽门"}),n.jsx("text",{className:"rmg-name__en",fontSize:6.5,dy:36,children:"Screen Door"})]})}const se=e=>{const t=(a=>{switch(a){case"gz28":case"gz2otis":case"gz6":case"gzgf":return 60;case"gz1":case"gz3":return 40;case"gz4":case"gz5":case"gz1421":return 20;default:return 0}})(e.variant),s=d.useMemo(()=>{switch(e.variant){case"gz1":return n.jsx("circle",{cy:-58,r:16,fill:"red"});case"gz28":case"gz2otis":return n.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"orange"});case"gz3":return n.jsx("rect",{x:-15,y:-55,height:30,width:30,fill:"red"});case"gz6":return n.jsx("ellipse",{cy:-30,rx:24,ry:12,fill:"white"});case"gz1421":return n.jsx("ellipse",{cy:-38,rx:24,ry:12,fill:"orange"});case"gz5":return n.jsx("rect",{x:-30,y:-70,height:30,width:60,fill:"orange"});case"gz4":return n.jsx("rect",{x:-50,y:-50,height:25,width:100,fill:"whitesmoke"});case"gzgf":return n.jsx("rect",{x:-30,y:-58,height:30,width:60,fill:"orange"});default:return n.jsx(n.Fragment,{})}},[e.variant]);return n.jsxs("g",{transform:"translate(0,".concat(e.variant==="gz4"?-20:0,")"),children:[n.jsx("rect",{id:"strip_gz",style:{"--height":"".concat(t,"px")}}),n.jsx("g",{style:{transform:"translate(calc(var(--rmg-svg-width) / 2),var(--rmg-svg-height))"},children:e.isShowLight&&s}),e.isShowPSD!==!1&&n.jsx(je,{...e})]})},je=d.memo(function(t){const s=["gz28","gz2otis","gz6","gzgf"].includes(t.variant),r=(a=>{switch(a){case"gz1":case"gz3":return"82px";case"gz4":return"65px";case"gz5":return"80px";case"gz1421":return"62px";default:return"58px"}})(t.variant);return n.jsx(_e,{num:t.isShowPSD,inStrip:s,style:{"--psd-dy":r,transform:"translate(var(--translate-x), var(--translate-y))","--translate-x":"calc(var(--rmg-svg-width) / 2 + 80px)","--translate-y":"calc(var(--rmg-svg-height) - var(--psd-dy, 58px))"}})},(e,t)=>e.variant===t.variant&&e.isShowPSD===t.isShowPSD);var ie=1.3,oe=18.5;var D=45,O=D-3,le=function(e,t){var s=[e,t].map(function(r){return r.match(/^(\w+).+$/)});if(s[0]&&s[1]&&s[0][1]===s[1][1])return s[0][1]},X=function(e){var t=e.match(/^(\d+)\D+$/);return t==null?void 0:t[1]},H=function(){return H=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},H.apply(this,arguments)},pe=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s};function W(e){var t=e.customWidth,s=pe(e,["customWidth"]),r=(t!=null?t:D)-D;return n.jsx("rect",H({x:-22.5-r/2,height:24,width:t!=null?t:D,rx:4.5},s,{"data-testid":"intBox"}))}var ve=function(e,t){var s=typeof Symbol=="function"&&e[Symbol.iterator];if(!s)return e;var r=s.call(e),a,o=[],i;try{for(;(t===void 0||t-- >0)&&!(a=r.next()).done;)o.push(a.value)}catch(c){i={error:c}}finally{try{a&&!a.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o},Se=function(e,t){var s=X(e);if(s)return{isDigit:!0,spanningPart:s};var r=le(e,t);return r?{isDigit:!1,spanningPart:r}:{isDigit:!1,spanningPart:""}};function J(e){var t=e.zhName,s=e.enName,r=e.foregroundColour,a=e.backgroundColour,o=e.zhClassName,i=e.enClassName,c=e.passed,m=Se(t,s),l=m.isDigit,h=m.spanningPart,u=d.useRef(null),f=ve(d.useState({x:0,height:0,width:0}),2),g=f[0],x=f[1];d.useEffect(function(){u.current&&x(u.current.getBBox())},[t,s]);var _=O/Math.max(O,g.width),y=(-g.x-g.width/2)*_,p=g.height*(1-_)/2;return n.jsxs("g",{textAnchor:"middle",fill:c?P.white:r,children:[n.jsx(W,{fill:c?"#aaa":a}),n.jsx("g",{ref:u,transform:"translate(".concat(y,",").concat(p,")scale(").concat(_,")"),children:n.jsxs("text",{className:o,fontSize:21,x:-1,y:12,textAnchor:"end",dominantBaseline:"central",children:[h,n.jsx("tspan",{className:o,fontSize:10,x:0,dy:-4,textAnchor:"start",dominantBaseline:"central",children:t.slice(h.length).trim()}),n.jsx("tspan",{className:i,fontSize:6.5,letterSpacing:-.1,x:0,dy:10,textAnchor:"start",dominantBaseline:"middle",children:l?s:s.slice(h.length).trim()})]})})]})}var q=function(e,t){var s=typeof Symbol=="function"&&e[Symbol.iterator];if(!s)return e;var r=s.call(e),a,o=[],i;try{for(;(t===void 0||t-- >0)&&!(a=r.next()).done;)o.push(a.value)}catch(c){i={error:c}}finally{try{a&&!a.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o};function Ne(e){var t,s=e.zhName,r=e.enName,a=e.foregroundColour,o=e.backgroundColour,i=e.zhClassName,c=e.enClassName,m=e.passed,l=(t=X(s))!==null&&t!==void 0?t:"",h=d.useRef(null),u=d.useRef(null),f=q(d.useState({width:0}),2),g=f[0],x=f[1],_=q(d.useState({width:0}),2),y=_[0],p=_[1];d.useEffect(function(){h.current&&x(h.current.getBBox()),u.current&&p(u.current.getBBox())},[s,r]);var B=O/Math.max(O,g.width),b=O/Math.max(O,y.width),E={nameZh:{y:7.3+13.5*(1-B)*B/2},nameEn:{y:19.5-9*(1-b)*b/2}};return n.jsxs("g",{textAnchor:"middle",fill:m?P.white:a,children:[n.jsx(W,{fill:m?"#aaa":o}),n.jsxs("text",{ref:h,className:i,fontSize:12,transform:"translate(0,".concat(E.nameZh.y,")scale(").concat(B,")"),dominantBaseline:"central",children:[n.jsx("tspan",{fontSize:16,dy:.7,dominantBaseline:"central",children:l}),n.jsx("tspan",{dy:-.7,dominantBaseline:"central",children:s.slice(l.length)})]}),n.jsx("text",{ref:u,className:c,fontSize:8,transform:"translate(0,".concat(E.nameEn.y,")scale(").concat(b,")"),dominantBaseline:"middle",children:r})]})}var ze=function(e,t){var s=typeof Symbol=="function"&&e[Symbol.iterator];if(!s)return e;var r=s.call(e),a,o=[],i;try{for(;(t===void 0||t-- >0)&&!(a=r.next()).done;)o.push(a.value)}catch(c){i={error:c}}finally{try{a&&!a.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o};function we(e){var t=e.zhName,s=e.enName,r=e.foregroundColour,a=e.backgroundColour,o=e.zhClassName,i=e.enClassName,c=e.passed,m=d.useRef(null),l=ze(d.useState({width:0}),2),h=l[0],u=l[1];d.useEffect(function(){m.current&&u(m.current.getBBox())},[t,s]);var f=Math.max(45,h.width+4);return n.jsxs("g",{textAnchor:"middle",fill:c?P.white:r,children:[n.jsx(W,{customWidth:f,fill:c?"#aaa":a}),n.jsxs("g",{ref:m,children:[n.jsx("text",{className:o,fontSize:8.5,y:8,dominantBaseline:"central",children:t}),n.jsx("text",{className:i,fontSize:5.5,y:18,dominantBaseline:"middle",children:s})]})]})}var K=function(e,t){var s=typeof Symbol=="function"&&e[Symbol.iterator];if(!s)return e;var r=s.call(e),a,o=[],i;try{for(;(t===void 0||t-- >0)&&!(a=r.next()).done;)o.push(a.value)}catch(c){i={error:c}}finally{try{a&&!a.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o};function Be(e){var t=e.zhName,s=e.enName,r=e.foregroundColour,a=e.backgroundColour,o=e.zhClassName,i=e.enClassName,c=e.passed,m=d.useRef(null),l=d.useRef(null),h=K(d.useState({width:0}),2),u=h[0],f=h[1],g=K(d.useState({width:0}),2),x=g[0],_=g[1];d.useEffect(function(){m.current&&f(m.current.getBBox()),l.current&&_(l.current.getBBox())},[t,s]);var y=O/Math.max(O,u.width),p=O/Math.max(O,x.width),B={nameZh:{y:7.3+13.5*(1-y)*y/2},nameEn:{y:19.5-9*(1-p)*p/2}};return n.jsxs("g",{textAnchor:"middle",fill:c?P.white:r,children:[n.jsx(W,{fill:c?"#aaa":a}),n.jsx("text",{ref:m,className:o,fontSize:12,transform:"translate(0,".concat(B.nameZh.y,")scale(").concat(y,")"),dominantBaseline:"central",children:t}),n.jsx("text",{ref:l,className:i,fontSize:8,transform:"translate(0,".concat(B.nameEn.y,")scale(").concat(p,")"),dominantBaseline:"middle",children:s})]})}var C=function(){return C=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},C.apply(this,arguments)};const ce=d.memo(function(t){var s=t.zhName,r=t.enName,a=t.spanDigits,o=be(s,r);switch(o){case 1:return a?n.jsx(J,C({},t)):n.jsx(Ne,C({},t));case 2:return n.jsx(J,C({},t));default:return s.length>=5?n.jsx(we,C({},t)):n.jsx(Be,C({},t))}});var be=function(e,t){var s=X(e);if(s!==void 0)return 1;var r=le(e,t);return r!==void 0?2:3},M=function(){return M=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},M.apply(this,arguments)},Oe=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s},R=5,I=5.625,Q=oe-R,ee=oe-2*I;d.memo(function(t){var s=t.stroke,r=t.filled,a=Oe(t,["stroke","filled"]),o="M0,9.25 V-9.25 H-".concat(Q," l-").concat(R,",").concat(I," v").concat(ee," l").concat(R,",").concat(I," H").concat(Q," l").concat(R,",-").concat(I," v-").concat(ee," l-").concat(R,",-").concat(I," H0");return n.jsx("path",M({d:o,fill:r?s:"#fff",strokeWidth:ie,stroke:s},a))});var Z=function(){return Z=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},Z.apply(this,arguments)},$e=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s};const Ee=d.memo(function(t){var s=t.stroke,r=t.filled,a=$e(t,["stroke","filled"]),o="M0,9.25 V-9.25 H-9.25 a9.25,9.25 0 0,0 0,18.5 h18.5 a9.25,9.25 0 0,0 0,-18.5 H0";return n.jsx("path",Z({d:o,fill:r?s:"#fff",strokeWidth:ie,stroke:s},a))});var F=function(){return F=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},F.apply(this,arguments)},Ce=function(e,t){var s={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(s[r]=e[r]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var a=0,r=Object.getOwnPropertySymbols(e);a<r.length;a++)t.indexOf(r[a])<0&&Object.prototype.propertyIsEnumerable.call(e,r[a])&&(s[r[a]]=e[r[a]]);return s},te=function(e,t){var s=typeof Symbol=="function"&&e[Symbol.iterator];if(!s)return e;var r=s.call(e),a,o=[],i;try{for(;(t===void 0||t-- >0)&&!(a=r.next()).done;)o.push(a.value)}catch(c){i={error:c}}finally{try{a&&!a.done&&(s=r.return)&&s.call(r)}finally{if(i)throw i.error}}return o},T=15;function Pe(e){var t=e.Icon,s=e.lineNum,r=e.stnNum,a=e.strokeColour,o=e.passed,i=e.size,c=e.textClassName,m=Ce(e,["Icon","lineNum","stnNum","strokeColour","passed","size","textClassName"]),l=d.useRef(null),h=d.useRef(null),u=te(d.useState({width:0}),2),f=u[0],g=u[1],x=te(d.useState({width:0}),2),_=x[0],y=x[1];d.useEffect(function(){l.current&&g(l.current.getBBox()),h.current&&y(h.current.getBBox())},[s,r]);var p=T/Math.max(T,f.width),B=(s==null?void 0:s.length)===2&&(r==null?void 0:r.length)===2?p:T/Math.max(T,_.width),b=i==="sm"?"0.7":i==="lg"?"1.4":1;return n.jsx("g",F({},m,{children:n.jsxs("g",{transform:"scale(".concat(b,")"),children:[n.jsx(t,{stroke:o?"#aaa":a,filled:!s&&!r}),(s||r)&&n.jsxs("g",{textAnchor:"middle",fontSize:13.5,fill:o?"#aaa":"#000",children:[n.jsx("g",{transform:"translate(-9.25,0)scale(".concat(p,")"),children:n.jsx("text",{ref:l,className:c,dominantBaseline:"central",x:.5,children:s})}),n.jsx("g",{transform:"translate(9.25,0)scale(".concat(B,")"),children:n.jsx("text",{ref:h,className:c,dominantBaseline:"central",children:r})})]})]})}))}var G=function(){return G=Object.assign||function(e){for(var t,s=1,r=arguments.length;s<r;s++){t=arguments[s];for(var a in t)Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a])}return e},G.apply(this,arguments)};function me(e){return n.jsx(Pe,G({Icon:Ee},e))}const ke=d.memo(function(t){const{stnName:s,onUpdate:r}=t,a=d.useRef(null);return d.useEffect(()=>{a.current&&r&&r(a.current.getBBox())},[s.toString()]),n.jsxs("g",{ref:a,children:[n.jsx("text",{className:"rmg-name__zh",fontSize:18,children:s[0]}),n.jsx("g",{fontSize:10.5,children:s[1].split("\\").map((o,i)=>n.jsx("text",{className:"rmg-name__en",dy:16+i*11,children:o},i))})]})},(e,t)=>e.stnName.toString()===t.stnName.toString());function Re(e){const{stnName:t,onUpdate:s,passed:r,...a}=e,o=d.useRef(null),[i,c]=d.useState({x:0,width:0});return d.useEffect(()=>{if(o.current){const m=o.current.getBBox();c(m),s==null||s(m)}},[t.toString()]),!t[0]&&!t[1]?n.jsx(n.Fragment,{}):n.jsxs("g",{fill:r?"#aaa":"#000",...a,children:[n.jsxs("g",{transform:"translate(0,3)",fontSize:18,children:[n.jsx("text",{textAnchor:"end",x:i.x-3,className:"rmg-name__zh",children:"("}),n.jsx("text",{textAnchor:"start",x:i.width+i.x+3,className:"rmg-name__zh",children:")"})]}),n.jsxs("g",{ref:o,textAnchor:"middle",children:[n.jsx("text",{className:"rmg-name__zh",fontSize:13,children:t[0]}),n.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:t[1]})]})]})}function Ie(e){const{passed:t,...s}=e;return n.jsxs("g",{textAnchor:"middle",fill:t?"#aaa":"var(--rmg-theme-colour)",...s,children:[n.jsx("text",{className:"rmg-name__zh",fontSize:13,children:"快车停靠站"}),n.jsx("text",{dy:10,className:"rmg-name__en",fontSize:6.5,children:"Express Station"})]})}function Ae(e){const{primaryName:t,secondaryName:s,stationState:r,flipped:a,express:o}=e,[i,c]=d.useState({width:0}),[m,l]=d.useState({x:0,width:-20}),h=g=>{switch(g){case k.PASSED:return"#aaa";case k.CURRENT:return"#f00";case k.FUTURE:return"#000"}},u=t[1].split("\\").length,f={g:{x:0,y:a?17.5:-20-u*14*Math.cos(-45)},StationSecondaryName:{x:(i.width+m.width/2+10)*(a?-1:1),y:2+5*(u-1)},ExpressTag:{x:(i.width+m.width+20+35)*(a?-1:1),y:2+5*(u-1)}};return n.jsxs("g",{textAnchor:a?"end":"start",fill:h(r),transform:"translate(".concat(f.g.x,",").concat(f.g.y,")rotate(-45)"),children:[n.jsx(ke,{stnName:t,onUpdate:c}),s&&n.jsx(Re,{stnName:s,onUpdate:l,passed:r===k.PASSED,transform:"translate(".concat(f.StationSecondaryName.x,",").concat(f.StationSecondaryName.y,")")}),o&&n.jsx(Ie,{passed:r===k.PASSED,transform:"translate(".concat(f.ExpressTag.x,",").concat(f.ExpressTag.y,")")})]})}function Te(e){var x,_,y,p,B,b;const{stnId:t,stnState:s,stnY:r}=e,{theme:a,line_name:o,line_num:i,spanLineNum:c,stn_list:m}=S(E=>E.param),l=m[t],h=l.parents.length===2||l.children.length===2,u=r>0||l.parents.indexOf(((_=(x=l.branch)==null?void 0:x.left)==null?void 0:_[1])||"")===1||l.children.indexOf(((p=(y=l.branch)==null?void 0:y.right)==null?void 0:p[1])||"")===1?180:0,f=l.name[1].split("\\").length,g=h?u===180?16+(f-1)*12*Math.cos(-45):-9:u===180?-6:(25+(f-1)*15)*Math.cos(-45);return n.jsxs(n.Fragment,{children:[n.jsx(De,{intInfos:h?[{theme:[a[0],a[1],"var(--rmg-theme-colour)","var(--rmg-theme-fg)"],name:o},...(B=l.transfer.groups[0].lines)!=null?B:[]]:(b=l.transfer.groups[0].lines)!=null?b:[],stnState:s,tickRotation:u,spanDigits:c}),n.jsx(me,{lineNum:i,stnNum:l.num,strokeColour:a[2],textClassName:"rmg-name__zh",passed:s===-1}),n.jsx("g",{transform:"translate(".concat(-g,",0)"),children:n.jsx(Ae,{primaryName:l.name,secondaryName:l.secondaryName||void 0,stationState:s,flipped:u===180,express:l.services.includes(he.express)})})]})}const De=e=>n.jsxs(n.Fragment,{children:[n.jsx(We,{strokeWidth:4,...e}),n.jsx(Le,{transform:"translate(0,".concat(e.tickRotation===180?-47:23,")"),...e})]}),We=e=>{const{intInfos:t,stnState:s,tickRotation:r,spanDigits:a,...o}=e;return n.jsx("g",{...o,children:t.map((i,c)=>{var m;return n.jsx("use",{xlinkHref:"#inttick",stroke:s===-1?"#aaa":(m=i.theme)==null?void 0:m[2],transform:"translate(".concat(-2*(t.length-1)+4*c,",0)rotate(").concat(r===180?180:0,")")},c)})})},Le=e=>{const{intInfos:t,tickRotation:s,stnState:r,spanDigits:a,...o}=e;return n.jsx("g",{...o,children:t.map((i,c)=>{var m,l,h,u;return n.jsx("g",{transform:"translate(0,".concat(c*28*(s===180?-1:1),")"),children:n.jsx(ce,{zhName:i.name[0],enName:i.name[1],foregroundColour:(l=(m=i.theme)==null?void 0:m[3])!=null?l:P.white,backgroundColour:(u=(h=i.theme)==null?void 0:h[2])!=null?u:"#aaaaaa",zhClassName:"rmg-name__zh",enClassName:"rmg-name__en",passed:r===-1,spanDigits:a})},c)})})},ne=(e,t)=>e[t].parents.length===2||e[t].children.length===2?.25:0,He=(e,t,s)=>{const r=v("linestart","lineend",t);if(r.nodes.includes(e))return v(r.nodes[1],e,t).len;{const a=s.filter(l=>l.includes(e))[0];let o=e;for(;!r.nodes.includes(o);)o=a[a.indexOf(o)-1];let i=e;for(;!r.nodes.includes(i);)i=a[a.indexOf(i)+1];const c=o==="linestart",m=i==="lineend";if(a.toString()===s[0].toString()){const l=[];return!c&&!m?(l[0]=v(r.nodes[1],o,t).len,l[1]=v(o,i,t).len,l[2]=v(o,e,t).len,l[3]=v(e,i,t).len):c?(l[0]=0,l[1]=v(r.nodes[1],i,t).len,l[2]=v(a[1],e,t).len,l[3]=v(e,i,t).len):(l[0]=v(r.nodes[1],o,t).len,l[1]=v(o,r.nodes.slice(-2)[0],t).len,l[2]=v(o,e,t).len,l[3]=v(e,a.slice(-2)[0],t).len),l[0]+l[2]*l[1]/(l[2]+l[3])}else if(!c&&!m){const l=[];return l[0]=v(r.nodes[1],o,t).len,l[1]=v(o,i,t).len,l[2]=v(o,e,t).len,l[3]=v(e,i,t).len,l[0]+l[2]*l[1]/(l[2]+l[3])}else return c?v(r.nodes[1],i,t).len-v(e,i,t).len:v(r.nodes[1],o,t).len+v(o,e,t).len}},Me=()=>{const{branches:e,routes:t,depsStr:s}=S(N=>N.helper),{svgWidth:r,svg_height:a,y_pc:o,padding:i,branchSpacingPct:c,direction:m,line_name:l,spanLineNum:h,current_stn_idx:u,stn_list:f}=S(N=>N.param),g=fe(f,ne,ne),x=d.useMemo(()=>(console.log("computing x shares"),Object.keys(f).reduce((N,z)=>({...N,[z]:He(z,g,e)}),{})),[e.toString(),JSON.stringify(g)]),_=v("linestart","lineend",g),y=v(_.nodes[1],_.nodes.slice(-2)[0],g),p=m===j.right?[r[w.RailMap]*i/100+65,r[w.RailMap]*(1-i/100)-20]:[r[w.RailMap]*i/100,r[w.RailMap]*(1-i/100)-65],B=Object.keys(x).reduce((N,z)=>({...N,[z]:p[0]+x[z]/y.len*(p[1]-p[0])}),{}),b=d.useMemo(()=>(console.log("computing y shares"),Object.keys(f).reduce((N,z)=>{if(e[0].includes(z))return{...N,[z]:0};{const A=e.slice(1).filter(ue=>ue.includes(z))[0];return{...N,[z]:f[A[0]].children.indexOf(A[1])?-2:2}}},{})),[s]),E=Object.keys(b).reduce((N,z)=>({...N,[z]:-b[z]*c*a/200}),{}),V=d.useMemo(()=>xe(u,t,m),[u,m,t.toString()]),Y=e.map(N=>ge(N,V)).reduce((N,z)=>(N.main.push(z.main),N.pass.push(z.pass),N),{main:[],pass:[]}),de=Object.keys(Y).reduce((N,z)=>({...N,[z]:Y[z].map(A=>Fe(A,B,E))}),{});return n.jsxs("g",{id:"main",style:{"--y-percentage":o,transform:"translateY(calc(var(--y-percentage) * var(--rmg-svg-height) / 100))"},children:[n.jsx(Ze,{paths:de}),n.jsx(Ge,{xs:B,ys:E,stnStates:V}),n.jsx("g",{id:"line_name",style:{"--translate-x":m===j.right?"".concat(p[0]-65,"px"):"".concat(p[1]+65,"px")},children:n.jsx(ce,{zhName:l[0],enName:l[1],foregroundColour:"var(--rmg-theme-fg)",backgroundColour:"var(--rmg-theme-colour)",zhClassName:"rmg-name__zh",enClassName:"rmg-name__en",spanDigits:h})})]})},Ze=d.memo(function(t){return n.jsxs("g",{fill:"none",strokeWidth:4,children:[n.jsx("g",{stroke:"#aaa",strokeDasharray:4,children:t.paths.pass.map((s,r)=>n.jsx("path",{d:s},r))}),n.jsx("g",{stroke:"var(--rmg-theme-colour)",children:t.paths.main.map((s,r)=>n.jsx("path",{d:s},r))})]})},(e,t)=>JSON.stringify(e.paths)===JSON.stringify(t.paths)),Fe=(e,t,s)=>{let r;const a=[];return e.forEach(o=>{const i=t[o],c=s[o];if(!r&&r!==0){r=c,a.push("M ".concat(i,",").concat(c));return}c===0?(c<r&&a.push("H ".concat(i-40),"a 40,40 0 0,0 40,-40","V ".concat(c)),c>r&&a.push("H ".concat(i-40),"a 40,40 0 0,1 40,40","V ".concat(c))):(c<r&&a.push("V ".concat(c+40),"a 40,40 0 0,1 40,-40","H ".concat(i)),c>r&&a.push("V ".concat(c-40),"a 40,40 0 0,0 40,40","H ".concat(i))),a.push("H ".concat(i)),r=c}),a.join(" ").replace(/( H ([\d.]+))+/g," H $2")},Ge=e=>{const{xs:t,ys:s,stnStates:r}=e,a=S(o=>o.param.stn_list);return n.jsx("g",{id:"stn_icons",children:Object.keys(a).filter(o=>!["linestart","lineend"].includes(o)).map(o=>n.jsx("g",{style:{transform:"translate(".concat(t[o],"px,").concat(s[o],"px)")},children:n.jsx(Te,{stnId:o,stnState:r[o],stnY:s[o]})},o))})};function U(e){return n.jsx("path",{d:"M60,60 L0,0 L60,-60 H90 L40,-10 H150 V10 H40 L90,60z",fill:"black",...e})}function Xe(e){const{destIds:t,textAnchor:s,...r}=e,a=S(l=>l.param.direction),o=S(l=>l.param.stn_list),i=t.map(l=>o[l].name[0].length),c=Math.min(...i),m=c>1&&i[0]!==i[1]?Math.abs(i[0]-i[1])/(c-1):0;return n.jsxs("g",{textAnchor:s,...r,children:[t.map((l,h)=>{const u=i[h]>i[1-h],f=!ye()&&s==="end"&&!u;return n.jsxs(d.Fragment,{children:[n.jsx("text",{className:"rmg-name__zh",fontSize:25,x:a===j.left?0:-75,y:-21+42*h,letterSpacing:u?"0em":"".concat(m,"em"),dx:f?"".concat(m,"em"):"0em",children:o[l].name[0]}),n.jsx("text",{className:"rmg-name__en",fontSize:11.5,x:a===j.left?0:-75,y:-1+42*h,children:"Towards "+o[l].name[1].replace("\\"," ")})]},l)}),n.jsx("text",{className:"rmg-name__zh",fontSize:28,x:a===j.left?25*(Math.max(...i)+1):0,y:5,children:"方向"})]})}const re=w.RailMap,Ue=()=>{const{canvasScale:e}=S(f=>f.app),{svgWidth:t,svg_height:s,direction:r,psd_num:a,info_panel_type:o,notesGZMTR:i,current_stn_idx:c,stn_list:m,theme:l}=S(f=>f.param),h=t[re],u=m[c];return n.jsxs(ae,{type:re,svgWidth:h,svgHeight:s,canvasScale:e,theme:l,children:[n.jsx(Ve,{}),n.jsx(se,{variant:o,isShowLight:o===$.gz2otis,isShowPSD:o===$.gz2otis&&a}),r===j.left&&u.parents.includes("linestart")||r===j.right&&u.children.includes("lineend")?n.jsx(qe,{}):n.jsxs(n.Fragment,{children:[n.jsx(Me,{}),n.jsx(Ye,{}),i==null?void 0:i.map((f,g)=>n.jsx(Ke,{note:f},g))]}),o===$.gz2otis&&n.jsx("line",{x2:h,transform:"translate(0,90)",strokeWidth:3,stroke:"black"})]})},Ve=d.memo(function(){return n.jsx("defs",{children:n.jsx("path",{id:"inttick",d:"M 0,0 v 18",strokeLinecap:"square"})})}),Ye=()=>{const{routes:e}=S(c=>c.helper),{direction:t,direction_gz_x:s,direction_gz_y:r,current_stn_idx:a}=S(c=>c.param),o=d.useMemo(()=>[...new Set(e.reduce((c,m)=>m.includes(a)?c.concat(m.filter(l=>!["linestart","lineend"].includes(l)).slice(t===j.left?0:-1)[0]):c,[]).filter(c=>c!==a))],[a,t,e.toString()]),i={textAnchor:t===j.left?"start":"end",transform:"translate(".concat(t===j.left?65:-65,",-5)"),destIds:o};return n.jsxs("g",{id:"direction_gz",style:{"--x-percentage":s,"--y-percentage":r},children:[n.jsx(U,{transform:"scale(0.35)rotate(".concat(t===j.left?0:180,")")}),o.length!==2?n.jsx(Je,{...i}):n.jsx(Xe,{...i})]})},Je=e=>{const{destIds:t,...s}=e,r=S(a=>a.param.stn_list);return n.jsxs("g",{...s,children:[n.jsx("text",{className:"rmg-name__zh",fontSize:28,children:t.map(a=>r[a].name[0]).join("/")+"方向"}),n.jsx("text",{className:"rmg-name__en",fontSize:14,dy:22,children:"Towards "+t.map(a=>r[a].name[1].replace("\\"," ")).join("/")})]})},qe=d.memo(function(){return n.jsxs("g",{id:"terminus_gz",textAnchor:"middle",children:[n.jsx("text",{className:"rmg-name__zh",fontSize:90,children:"终 点 站"}),n.jsx("text",{dy:70,className:"rmg-name__en",fontSize:36,children:"Terminal"}),n.jsxs("g",{strokeWidth:8,stroke:"#000",children:[n.jsx("path",{d:"M -160,68 h -160"}),n.jsx("path",{d:"M 160,68 h 160"})]})]})}),Ke=d.memo(function(t){const s=d.useRef(null),[r,a]=d.useState({width:0,height:0,y:0});return d.useEffect(()=>{s.current&&a(s.current.getBBox())},[t.note[0],t.note[1]]),n.jsxs("g",{className:"note-box",style:{"--x-percentage":t.note[2],"--y-percentage":t.note[3]},children:[t.note[4]&&n.jsx("rect",{height:r.height+4,width:r.width+4,x:-2,y:r.y-2,fill:"none",stroke:"black",strokeWidth:.5}),n.jsxs("g",{ref:s,children:[n.jsx("g",{fontSize:16,letterSpacing:1.2,children:t.note[0].split("\n").map((o,i)=>n.jsx("text",{className:"rmg-name__zh",y:i*18,children:o},i))}),n.jsx("g",{fontSize:10,letterSpacing:.33,transform:"translate(0,".concat(18*t.note[0].split("\n").length,")"),children:t.note[1].split("\n").map((o,i)=>{var c;return n.jsx("text",{className:"rmg-name__en",y:i*11,textLength:i<(((c=t.note[1].match(/\n/g))==null?void 0:c.length)||0)?r.width:navigator.userAgent.includes("Firefox")?-1:0,lengthAdjust:"spacing",children:o},i)})})]})]})},(e,t)=>e.note.toString()===t.note.toString()),Qe=d.memo(function(t){const{stnName:s,onUpdate:r}=t,a=d.useRef(null);return d.useEffect(()=>{a.current&&r&&r(a.current.getBBox())},[s.toString()]),n.jsxs("g",{ref:a,children:[n.jsx("text",{className:"rmg-name__zh",fontSize:90,children:s[0]}),n.jsx("g",{fontSize:36,children:s[1].split("\\").map((o,i)=>n.jsx("text",{className:"rmg-name__en",dy:70+i*36,children:o},i))})]})},(e,t)=>e.stnName.toString()===t.stnName.toString()),et=e=>{const{secondaryName:t,transform:s}=e,r=d.useRef(null),[a,o]=d.useState({x:0,width:0});return d.useEffect(()=>{r.current&&o(r.current.getBBox())},[t.toString()]),n.jsxs("g",{transform:s,children:[n.jsxs("g",{transform:"translate(0,4.5)",fontSize:36,children:[n.jsx("text",{textAnchor:"end",x:a.x-3,className:"rmg-name__zh",children:"("}),n.jsx("text",{textAnchor:"start",x:a.width+a.x+3,className:"rmg-name__zh",children:")"})]}),n.jsxs("g",{ref:r,textAnchor:"middle",children:[n.jsx("text",{className:"rmg-name__zh",fontSize:26,children:t[0]}),n.jsx("text",{dy:22,className:"rmg-name__en",fontSize:14,children:t[1]})]})]})},tt=()=>{const{svg_height:e,svgWidth:t,theme:s,direction:r,info_panel_type:a,line_num:o,current_stn_idx:i,stn_list:c}=S(x=>x.param),m=c[i],[l,h]=d.useState({width:0}),u=m[r===j.left?"parents":"children"],f={name:"translate(".concat((r===j.left?1:-1)*t[w.RunIn]/4,",45)"),next:"translate(".concat((r===j.left?1:-1)*t[w.RunIn]/10,",45)")},g={nameGroup:{x:t.runin/2,y:.5*e-50-(m.name[1].split("\\").length-1)*18-(m.secondaryName?29:0)},secondaryName:{x:0,y:70+m.name[1].split("\\").length*36}};return n.jsxs("g",{children:[n.jsxs("g",{transform:a===$.gz2otis?f.name:"",children:[n.jsxs("g",{textAnchor:"middle",transform:"translate(".concat(g.nameGroup.x,",").concat(g.nameGroup.y,")"),children:[n.jsx(Qe,{stnName:m.name,onUpdate:h}),m.secondaryName&&n.jsx(et,{secondaryName:m.secondaryName,transform:"translate(".concat(g.secondaryName.x,",").concat(g.secondaryName.y,")")})]}),n.jsx(me,{lineNum:o,stnNum:m.num,strokeColour:s[2],textClassName:"rmg-name__zh",style:{"--translate-x":"".concat((t[w.RunIn]+l.width)/2+55,"px"),"--translate-y":"".concat(.5*e-30-(m.name[1].split("\\").length-1)*18-(m.secondaryName?58/2:0),"px"),transform:"translate(var(--translate-x, 800px), var(--translate-y, 145px))"},size:"lg"})]}),n.jsx("g",{transform:a===$.gz2otis?f.next:"",children:!u||u.includes("linestart")||u.includes("lineend")?n.jsx(n.Fragment,{}):u.length===1?n.jsx(nt,{nextId:u[0],nameBBox:l}):n.jsx(at,{nextIds:u,nameBBox:l})})]})},nt=e=>{const{nextId:t,nameBBox:s}=e,r=S(g=>g.param.svgWidth),a=S(g=>g.param.direction),o=S(g=>g.param.stn_list[t]),{name:i,secondaryName:c}=o,[m,l]=d.useState({width:0}),h=d.useRef(null);d.useEffect(()=>{h.current&&l(h.current.getBBox())},[i.toString()]);const u=i[0].length,f=(r[w.RunIn]-s.width)/2;return n.jsxs(n.Fragment,{children:[n.jsxs("g",{id:"big_next",children:[n.jsxs("g",{textAnchor:"middle",style:{"--translate-x":a===j.left?"80px":u<=2?"".concat(r[w.RunIn]-45-m.width-70,"px"):"".concat(r[w.RunIn]-45-m.width-35*1.5,"px")},children:[n.jsx("text",{className:"rmg-name__zh",fontSize:35,children:"下站"}),n.jsx("text",{className:"rmg-name__en",fontSize:17,dy:30,children:"Next"})]}),n.jsxs("g",{textAnchor:"start",ref:h,style:{"--translate-x":a===j.left?u<=2?"150px":"".concat(115+35/2,"px"):"".concat(r[w.RunIn]-45-m.width,"px")},children:[n.jsx("text",{className:"rmg-name__zh",fontSize:35,children:i[0]}),n.jsx("g",{fontSize:17,children:i[1].split("\\").map((g,x)=>n.jsx("text",{className:"rmg-name__en",dy:30+x*17,children:g},x))})]}),c&&n.jsx("g",{textAnchor:"middle",style:{"--translate-x":a===j.left?u<=2?"150px":"".concat(115+35/2,"px"):"".concat(r[w.RunIn]-45-m.width,"px")},children:n.jsx(rt,{secName:c,transform:"translate(".concat(m.width/2,",").concat(30+i[1].split("\\").length*17+5,")")})})]}),n.jsx(U,{id:"arrow",style:{"--translate-x":a===j.left?"".concat((115+35*((u<=2?1:.5)+u)+f)/2-20,"px"):"".concat((r[w.RunIn]-45-m.width-(u<=2?105:35*2.5)+f+e.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":a===j.left?"0deg":"180deg"}})]})},rt=e=>{const{secName:t,...s}=e,r=d.useRef(null),[a,o]=d.useState({x:0,width:0});return d.useEffect(()=>{r.current&&o(r.current.getBBox())},[e.secName.toString()]),n.jsxs("g",{...s,children:[n.jsxs("g",{transform:"translate(0,2.5)",fontSize:25,children:[n.jsx("text",{textAnchor:"end",x:a.x-3,className:"rmg-name__zh",children:"("}),n.jsx("text",{textAnchor:"start",x:a.width+a.x+3,className:"rmg-name__zh",children:")"})]}),n.jsxs("g",{ref:r,children:[n.jsx("text",{className:"rmg-name__zh",fontSize:18,children:t[0]}),n.jsx("text",{className:"rmg-name__en",fontSize:10,dy:15,children:t[1]})]})]})},at=e=>{const{nextIds:t,nameBBox:s}=e,{routes:r}=S(x=>x.helper),a=S(x=>x.param.svgWidth),o=S(x=>x.param.direction),i=S(x=>x.param.stn_list),c=t.map(x=>i[x].name),[m,l]=d.useState({width:0}),h=d.useRef([]);d.useEffect(()=>{l(x=>({...x,width:0})),h.current.forEach(x=>{const _=x==null?void 0:x.getBBox();l(y=>_?y.width>_.width?y:_:y)})},[c.toString()]);const u=e.nextIds.map(x=>r.reduce((_,y)=>y.includes(x)?_.concat(y.filter(p=>!["linestart","lineend"].includes(p)).slice(o===j.left?0:-1)[0]):_,[])),f=Math.max(...c.map(x=>x[0].length)),g=(a[w.RunIn]-s.width)/2;return n.jsxs(n.Fragment,{children:[n.jsx("g",{id:"big_next_2",children:c.map((x,_)=>n.jsxs(d.Fragment,{children:[n.jsxs("g",{textAnchor:"middle",style:{"--translate-x":o===j.left?"72px":"".concat(a[w.RunIn]-45-m.width-41,"px")},children:[n.jsx("text",{className:"rmg-name__zh",children:"下站"}),n.jsx("text",{className:"rmg-name__en",y:22,children:"Next"})]}),n.jsxs("g",{ref:y=>h.current[_]=y,textAnchor:"start",style:{"--translate-x":o===j.left?"113px":"".concat(a[w.RunIn]-45-m.width,"px")},children:[n.jsx("text",{className:"rmg-name__zh",children:x[0]}),x[1].split("\\").map((y,p)=>n.jsx("text",{className:"rmg-name__en",y:22+p*13,children:y},p)),n.jsx("text",{className:"rmg-name__zh",y:-35,children:u[_].map(y=>i[y].name[0]).join("/")+"方向"}),n.jsx("text",{className:"rmg-name__en rmg-name__gzmtr--next2-dest",y:-20,children:"Towards "+u[_].map(y=>i[y].name[1]).join("/").replace("\\"," ")})]})]},_))}),n.jsx(U,{id:"arrow",style:{"--translate-x":o===j.left?"".concat((99+27*(1+f)+g)/2-20,"px"):"".concat((a[w.RunIn]-45-m.width-41-27+g+e.nameBBox.width+55+18.5*1.4)/2+20,"px"),"--rotate":o===j.left?"0deg":"180deg"}})]})};function st(e){const{num:t,...s}=e;return n.jsxs("g",{textAnchor:"middle",fill:"var(--rmg-theme-fg)",...s,children:[n.jsx("circle",{cx:0,cy:0,r:30,fill:"var(--rmg-theme-colour)"}),n.jsx("text",{className:"rmg-name__en",fontSize:38,dy:-9.5,children:t}),n.jsx("text",{className:"rmg-name__zh",fontSize:13,dy:10,children:"站台"}),n.jsx("text",{className:"rmg-name__en",fontSize:9,dy:21,children:"Platform"})]})}function it(e){const{canvasType:t}=e,{svgWidth:s,svg_height:r}=S(a=>a.param);return n.jsxs("g",{id:"otis_frame",strokeWidth:3,stroke:"black",children:[n.jsx("line",{y2:r,transform:"translate(".concat(s[t]/2,",0)")}),n.jsx("line",{x2:s[t],transform:"translate(0,90)"})]})}const L=w.RunIn;function ot(){const{canvasScale:e}=S(h=>h.app),{svgWidth:t,svg_height:s,direction:r,info_panel_type:a,platform_num:o,psd_num:i,theme:c}=S(h=>h.param),m=t[L],l={platform:"translate(".concat(r===j.left?50:-50,",45)")};return n.jsxs(ae,{type:L,svgWidth:m,svgHeight:s,canvasScale:e,theme:c,children:[n.jsx(se,{variant:a,isShowLight:a!==$.gz2otis,isShowPSD:a!==$.gz2otis&&i}),n.jsx("g",{transform:a===$.gz2otis?l.platform:"",children:n.jsx(st,{num:o,style:{"--translate-x":"".concat(r===j.left?m-100:100,"px"),"--translate-y":"calc(var(--rmg-svg-height) / 2 - 30px)",transform:"translate(var(--translate-x, 100px), var(--translate-y))"}})}),n.jsx(tt,{}),a===$.gz2otis&&n.jsx(it,{canvasType:L})]})}const ht={runin:n.jsx(ot,{}),railmap:n.jsx(Ue,{})};export{ht as default};
